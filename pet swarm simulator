--[[
    SCRIPT FINAL - ULTRA OTIMIZADO
    - Bloqueio total do pop-up de coins (som + visual + erros)
    - Desativação do script NestUtils (causador do erro)
    - Farms ajustadas: plant 9x rápido, hash 1x rápido, nests 0.3s, demais 0.5s
    - Sem prints, sem notificações, apenas o essencial
]]

-- Carregar interface
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

-- ========== BLOQUEIO TOTAL DE POP-UP ==========
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LogService = game:GetService("LogService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = Workspace.CurrentCamera

-- Mata todos os sons relacionados a moedas (evita o som do drop)
local function killCoinSounds()
    for _, obj in ipairs(Camera:GetDescendants()) do
        if obj:IsA("Sound") and (obj.Name:lower():find("coin") or obj.Name:lower():find("drop") or obj.Name:lower():find("currency")) then
            obj:Stop(); obj:Destroy()
        end
    end
    for _, obj in ipairs(PlayerGui:GetDescendants()) do
        if obj:IsA("Sound") and (obj.Name:lower():find("coin") or obj.Name:lower():find("drop") or obj.Name:lower():find("currency")) then
            obj:Stop(); obj:Destroy()
        end
    end
    for _, obj in ipairs(CoreGui:GetDescendants()) do
        if obj:IsA("Sound") and (obj.Name:lower():find("coin") or obj.Name:lower():find("drop") or obj.Name:lower():find("currency")) then
            obj:Stop(); obj:Destroy()
        end
    end
end
killCoinSounds()

-- Remove qualquer CurrencyPopUp existente
local alvos = {"CurrencyPopUp", "CoinsDrop", "coins", "CoinSurfaceGui", "Coin"}
local function destruirAlvos(container)
    for _, v in ipairs(container:GetDescendants()) do
        for _, nome in ipairs(alvos) do
            if v.Name == nome or v.Name:find(nome) then
                v:Destroy()
            end
        end
    end
end
destruirAlvos(Camera)
destruirAlvos(PlayerGui)
destruirAlvos(CoreGui)
destruirAlvos(Workspace)

-- Monitora criação de novos pop-ups e os destrói antes que apareçam
local function monitorar(descendant)
    task.wait() -- pequeno delay para garantir que o objeto foi criado
    for _, nome in ipairs(alvos) do
        if descendant.Name == nome or descendant.Name:find(nome) then
            descendant:Destroy()
            break
        end
    end
end
Camera.DescendantAdded:Connect(monitorar)
PlayerGui.DescendantAdded:Connect(monitorar)
CoreGui.DescendantAdded:Connect(monitorar)
Workspace.DescendantAdded:Connect(monitorar)

-- Suprime TODOS os erros relacionados a CurrencyPopUp e NestUtils no console
LogService.MessageOut:Connect(function(message, messageType)
    if messageType == Enum.MessageType.Error and 
       (message:find("CurrencyPopUp") or message:find("NestUtils") or message:find("attempt to index nil with 'Data'")) then
        return -- ignora completamente
    end
end)

-- Desativa o script UiFramework (responsável por muitos erros visuais)
local function neutralizeUiFramework()
    local playerScripts = LocalPlayer:FindFirstChild("PlayerScripts")
    if playerScripts then
        local uiFramework = playerScripts:FindFirstChild("Player") and 
                            playerScripts.Player:FindFirstChild("Main") and 
                            playerScripts.Player.Main:FindFirstChild("UiFramework")
        if uiFramework and uiFramework:IsA("LocalScript") then
            uiFramework.Name = "UiFramework_Disabled"
        end
    end
end
neutralizeUiFramework()

-- ========== DESATIVAÇÃO DO SCRIPT NESTUTILS (CAUSADOR DO ERRO) ==========
-- Esse script está em ReplicatedStorage.SharedModules.Game.NestUtils
-- Vamos renomeá-lo para que o jogo não o execute mais
local function disableNestUtils()
    local sharedModules = ReplicatedStorage:FindFirstChild("SharedModules")
    if sharedModules then
        local gameModule = sharedModules:FindFirstChild("Game")
        if gameModule then
            local nestUtils = gameModule:FindFirstChild("NestUtils")
            if nestUtils then
                nestUtils.Name = "NestUtils_Disabled"
            end
        end
    end
end
disableNestUtils()

-- ========== BLOQUEIO DA ANIMAÇÃO DE HATCH (EVITA ERRO DE REMOTEEVENT) ==========
local Events = ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("Events")
if Events then
    local oldAnim = Events:FindFirstChild("HatchAnimationEvent")
    if oldAnim then oldAnim:Destroy() end
    local fakeAnim = Instance.new("RemoteEvent")
    fakeAnim.Name = "HatchAnimationEvent"
    fakeAnim.Parent = Events
    fakeAnim.OnClientEvent:Connect(function() end)
end

-- ========== FARMS OTIMIZADAS ==========
local Remotes = ReplicatedStorage.Remotes
local Events = Remotes.Events
local Functions = Remotes.Functions

local CombatRF = Functions.CombatRF
local CollectionRF = Functions.CollectionRF
local HatchEggEvent = Events.HatchEggEvent
local PlantEggEvent = Events.PlantEggEvent
local ZonesRF = Functions.ZonesRF
local FeedEggEvent = Events.FeedEggEvent

-- Estado
local active = false
local cacheZones = {}
local eggsSelected = { "SummerEvent1" } -- selecionado por padrão
local bossEnabled = {}
local threads = {}

-- Configurações fixas (valores definidos)
local config = {
    autoPlant = true,
    plantBurstCount = 9,
    plantBurstDelay = 0.01,
    autoHash = true,
    hashCount = 1,
    hashDelay = 0.0001,
    autoFeedNests = true,
    feedDelay = 0.3,
    farmBosses = true,
    bossDelay = 0.5,
    farmSummer = true,
    summerDelay = 0.5,
    farmFood = true,
    foodDelay = 0.5,
}

-- Dados
local eggData = {
    { name = "Summer Egg", zone = "SummerEvent1" },
    { name = "Winter Egg", zone = "WinterEvent1" },
    { name = "Draco Egg", zone = "34" },
    { name = "Crystal Egg", zone = "12.1" },
    { name = "Sphinx Egg", zone = "EleEgg1" },
    { name = "Octopus Egg", zone = "30" },
    { name = "Tiki Egg", zone = "24" },
    { name = "Void Egg", zone = "27" },
    { name = "Desert Egg", zone = "6" },
}

local bossList = {
    { name = "Naga", zone = "Zone2B1", special = false },
    { name = "Lava Monster", zone = "Zone5B1", special = false },
    { name = "Ghost Pirate", zone = "Zone8B1", special = true, nilBoss = true },
    { name = "Tiki Monster", zone = "Zone10B1", special = false },
    { name = "The Big 100M", zone = "Zone12B3", special = false },
    { name = "The Frozen Ancient", zone = "Zone12B1", special = false },
    { name = "The Ethereal Everia", zone = "Zone12B2", special = false },
    { name = "Hornet Boss", zone = "SummerEventZoneB1", special = true },
    { name = "The Ice Serpent", zone = "WinterEventZoneB1", special = false },
    { name = "Great Sphinx", zone = "ElementEventZoneB1", special = false },
}
for _, v in ipairs(bossList) do bossEnabled[v.name] = true end

-- Cooldown boss
local bossCooldown = {}
for _, v in ipairs(bossList) do bossCooldown[v.name] = 0 end

-- Funções auxiliares
local function getZone(zoneName)
    if not cacheZones[zoneName] then
        cacheZones[zoneName] = Workspace.Zones:FindFirstChild(zoneName)
    end
    return cacheZones[zoneName]
end

local function getPets()
    if not LocalPlayer.Character then return {} end
    local pets = LocalPlayer.Character:FindFirstChild("Pets")
    return pets and pets:GetChildren() or {}
end

local function findNilBoss(name)
    for _, v in pairs(getnilinstances()) do
        if v.ClassName == "Vector3Value" and v.Name == name then return v end
    end
end

-- Limpeza de cache
task.spawn(function() while task.wait(300) do cacheZones = {} end end)

-- Loops (todos com pcall e sem prints)
local function PlantLoop()
    while threads.plant and active do
        if #eggsSelected > 0 then
            for _, zone in ipairs(eggsSelected) do
                for _ = 1, config.plantBurstCount do
                    if not active then break end
                    pcall(PlantEggEvent.FireServer, PlantEggEvent, zone)
                end
                task.wait(config.plantBurstDelay)
            end
        end
        task.wait(0.01)
    end
end

local function HashLoop()
    while threads.hash and active do
        for _ = 1, config.hashCount do
            if not active then break end
            pcall(HatchEggEvent.FireServer, HatchEggEvent)
            task.wait(config.hashDelay)
        end
        task.wait(config.hashDelay)
    end
end

local function FeedLoop()
    while threads.feed and active do
        local nests = Workspace:FindFirstChild("Nests")
        if nests then
            for _, nest in ipairs(nests:GetChildren()) do
                if not active then break end
                pcall(FeedEggEvent.FireServer, FeedEggEvent, nest)
            end
        end
        task.wait(config.feedDelay)
    end
end

local function BossLoop()
    while threads.boss and active do
        local pets = getPets()
        if #pets > 0 then
            local now = os.clock()
            local petCycle = 0
            for _, boss in ipairs(bossList) do
                if not active then break end
                if bossEnabled[boss.name] and now - bossCooldown[boss.name] >= config.bossDelay then
                    if boss.special then
                        pcall(ZonesRF.InvokeServer, ZonesRF, "RequestZoneMap", boss.zone)
                    end
                    local enemy
                    if boss.nilBoss then
                        enemy = findNilBoss(boss.name)
                    else
                        local zoneObj = getZone(boss.zone)
                        enemy = zoneObj and zoneObj:FindFirstChild("Enemies") and zoneObj.Enemies:FindFirstChild(boss.name)
                    end
                    if enemy then
                        petCycle = petCycle % #pets + 1
                        pcall(CombatRF.InvokeServer, CombatRF, "AttackEnemy", enemy, pets[petCycle])
                        bossCooldown[boss.name] = now
                    end
                end
            end
        end
        task.wait(0.1)
    end
end

local function SummerLoop()
    while threads.summer and active do
        local zone = getZone("SummerEventZone")
        local pets = getPets()
        if zone and zone:FindFirstChild("Enemies") and #pets > 0 then
            local idx = 1
            for _, enemy in ipairs(zone.Enemies:GetChildren()) do
                if not active then break end
                pcall(CombatRF.InvokeServer, CombatRF, "AttackEnemy", enemy, pets[idx])
                idx = idx % #pets + 1
            end
        end
        task.wait(config.summerDelay)
    end
end

local function FoodLoop()
    while threads.food and active do
        local zone = getZone("Zone12.1")
        local pets = getPets()
        if zone and zone:FindFirstChild("FoodSpawns") and #pets > 0 then
            local idx = 1
            for _, food in ipairs(zone.FoodSpawns:GetChildren()) do
                if not active then break end
                pcall(CollectionRF.InvokeServer, CollectionRF, "CollectFood", food, pets[idx])
                idx = idx % #pets + 1
            end
        end
        task.wait(config.foodDelay)
    end
end

-- Gerenciamento de threads
local function startThreads()
    threads = { plant = true, hash = true, feed = true, boss = true, summer = true, food = true }
    task.spawn(PlantLoop)
    task.spawn(HashLoop)
    task.spawn(FeedLoop)
    task.spawn(BossLoop)
    task.spawn(SummerLoop)
    task.spawn(FoodLoop)
end

local function stopThreads()
    for k, _ in pairs(threads) do threads[k] = false end
    threads = {}
end

local function start()
    if active then return end
    active = true
    startThreads()
end

local function stop()
    active = false
    stopThreads()
end

-- ========== INTERFACE RAYFIELD SIMPLES ==========
local Window = Rayfield:CreateWindow({
    Name = "Maverick Hub",
    LoadingTitle = "Carregando...",
    LoadingSubtitle = "Versão Final",
    ConfigurationSaving = { Enabled = true, FolderName = "MaverickHub", FileName = "Config" },
    Theme = "Dark"
})

local MainTab = Window:CreateTab("Principal", "home")
local EggTab = Window:CreateTab("Ovos", "package")
local BossTab = Window:CreateTab("Chefes", "shield")
local OtherTab = Window:CreateTab("Outros", "zap")

-- Principal
MainTab:CreateSection("Controle")
MainTab:CreateButton({ Name = "Iniciar", Callback = start })
MainTab:CreateButton({ Name = "Parar", Callback = stop })

local statusLabel = MainTab:CreateLabel("Status: Parado")
task.spawn(function()
    while true do
        task.wait(0.2)
        statusLabel:Set("Status: " .. (active and "Ativo" or "Parado"))
    end
end)

-- Ovos
EggTab:CreateSection("Selecione os ovos")
for _, egg in ipairs(eggData) do
    EggTab:CreateToggle({
        Name = egg.name,
        CurrentValue = (egg.zone == "SummerEvent1"),
        Callback = function(val)
            if val then
                if not table.find(eggsSelected, egg.zone) then
                    table.insert(eggsSelected, egg.zone)
                end
            else
                local idx = table.find(eggsSelected, egg.zone)
                if idx then table.remove(eggsSelected, idx) end
            end
        end
    })
end

-- Chefes
BossTab:CreateSection("Selecione os chefes")
for _, boss in ipairs(bossList) do
    BossTab:CreateToggle({
        Name = boss.name,
        CurrentValue = bossEnabled[boss.name],
        Callback = function(v) bossEnabled[boss.name] = v end
    })
end

-- Outros (apenas para manter)
OtherTab:CreateSection("Farms adicionais")
OtherTab:CreateLabel("Summer, Food e Nests já ativos")
